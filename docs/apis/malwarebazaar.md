# MalwareBazaar API Reference

API for downloading/uploading malware samples and querying threat intelligence from abuse.ch.

## Authentication

All requests require the `Auth-Key` HTTP header:

```bash
--header "Auth-Key: $MALWAREBAZAAR_API_KEY"
```

Get keys at: https://auth.abuse.ch

## Endpoint

All requests go to: `https://mb-api.abuse.ch/api/v1/` (POST only)

## Key Operations

### Download a Sample

```bash
curl -X POST "https://mb-api.abuse.ch/api/v1/" \
  -H "Auth-Key: $MALWAREBAZAAR_API_KEY" \
  -d "query=get_file&sha256_hash=HASH_HERE" \
  -o sample.zip
```

- Returns password-protected ZIP (password: `infected`)
- Uses AES128 encryption - requires `pyzipper` in Python (not standard `zipfile`)
- Daily download limits apply

### Query Sample Info

```bash
curl -X POST "https://mb-api.abuse.ch/api/v1/" \
  -H "Auth-Key: $MALWAREBAZAAR_API_KEY" \
  -d "query=get_info&hash=HASH_HERE"
```

Accepts SHA256, MD5, or SHA1. Returns:

- File metadata (name, size, type, timestamps)
- Signature/family attribution
- Tags
- Hashes (imphash, tlsh, ssdeep, etc.)
- Code signing info
- YARA rule matches
- Vendor intel (ANY.RUN, CAPE, Triage, etc.)

### Query by Tag

```bash
curl -X POST "https://mb-api.abuse.ch/api/v1/" \
  -H "Auth-Key: $MALWAREBAZAAR_API_KEY" \
  -d "query=get_taginfo&tag=TrickBot&limit=50"
```

Max 1000 results.

### Query by Signature/Family

```bash
curl -X POST "https://mb-api.abuse.ch/api/v1/" \
  -H "Auth-Key: $MALWAREBAZAAR_API_KEY" \
  -d "query=get_siginfo&signature=AgentTesla&limit=100"
```

### Query by File Type

```bash
curl -X POST "https://mb-api.abuse.ch/api/v1/" \
  -H "Auth-Key: $MALWAREBAZAAR_API_KEY" \
  -d "query=get_file_type&file_type=elf&limit=10"
```

### Query by YARA Rule

```bash
curl -X POST "https://mb-api.abuse.ch/api/v1/" \
  -H "Auth-Key: $MALWAREBAZAAR_API_KEY" \
  -d "query=get_yarainfo&yara_rule=win_remcos_g0&limit=50"
```

### Recent Samples (Last 60 min)

```bash
curl -X POST "https://mb-api.abuse.ch/api/v1/" \
  -H "Auth-Key: $MALWAREBAZAAR_API_KEY" \
  -d "query=get_recent&selector=time"
```

Or get latest N samples: `selector=100`

### Recent Detections

```bash
curl -X POST "https://mb-api.abuse.ch/api/v1/" \
  -H "Auth-Key: $MALWAREBAZAAR_API_KEY" \
  -d "query=recent_detections&hours=24"
```

Max 168 hours lookback.

## Similarity Searches

| Query            | Parameter    | Use Case                            |
| ---------------- | ------------ | ----------------------------------- |
| `get_imphash`    | `imphash`    | PE import table similarity          |
| `get_tlsh`       | `tlsh`       | Trend Micro locality-sensitive hash |
| `get_telfhash`   | `telfhash`   | ELF similarity                      |
| `get_gimphash`   | `gimphash`   | Go binary similarity                |
| `get_dhash_icon` | `dhash_icon` | PE icon visual similarity           |

## Code Signing Certificate Queries

```bash
# By issuer
query=get_issuerinfo&issuer_cn=Sectigo RSA Code Signing CA

# By subject
query=get_subjectinfo&subject_cn=Ekitai Data Inc.

# By serial number
query=get_certificate&serial_number=51CD5393514F7ACE2B407C3DBFB09D8D

# Get blocklist
query=get_cscb
```

## Upload a Sample

Multipart POST with `file` and `json_data`:

```python
import requests
import json

headers = {'Auth-Key': 'YOUR-KEY'}
data = {
    'anonymous': 0,
    'tags': ['exe', 'vsix'],
    'delivery_method': 'web_download',
}
files = {
    'json_data': (None, json.dumps(data), 'application/json'),
    'file': open('sample.bin', 'rb')
}
response = requests.post('https://mb-api.abuse.ch/api/v1/',
                         files=files, headers=headers)
```

Delivery methods: `email_attachment`, `email_link`, `web_download`, `web_drive-by`, `multiple`, `other`

## Batch Downloads

- Hourly: https://mb-api.abuse.ch/downloads/
- Daily: https://mb-api.abuse.ch/downloads/

Password: `infected`

## Submission Policy

- Confirmed malware only (no PUPs/adware)
- Fresh samples (<10 days old preferred)
- No file infectors
- Repeated violations = account ban

## Response Status Codes

| Status               | Meaning                           |
| -------------------- | --------------------------------- |
| `ok`                 | Success                           |
| `http_post_expected` | Must use POST                     |
| `no_api_key`         | Missing Auth-Key header           |
| `user_blacklisted`   | Account banned                    |
| `hash_not_found`     | Unknown sample                    |
| `file_not_found`     | Sample not available for download |
| `no_results`         | Query returned nothing            |

## Python Example

```python
import requests
import pyzipper
import os

def download_sample(sha256: str, api_key: str, output_dir: str) -> str:
    """Download and extract a sample from MalwareBazaar."""
    response = requests.post(
        'https://mb-api.abuse.ch/api/v1/',
        headers={'Auth-Key': api_key},
        data={'query': 'get_file', 'sha256_hash': sha256}
    )

    if response.headers.get('Content-Type') == 'application/json':
        raise Exception(response.json().get('query_status', 'Unknown error'))

    zip_path = os.path.join(output_dir, f'{sha256}.zip')
    with open(zip_path, 'wb') as f:
        f.write(response.content)

    # Extract with password
    with pyzipper.AESZipFile(zip_path) as zf:
        zf.extractall(output_dir, pwd=b'infected')

    os.remove(zip_path)
    return os.path.join(output_dir, sha256)
```

## Rate Limits

Community API is free under fair use principles. Commercial use may require paid subscription for the enhanced API.

## See Also

- [MalwareBazaar Browse](https://bazaar.abuse.ch/browse/)
- [GitHub Examples](https://github.com/abusech/MalwareBazaar/)
- [Java Client](https://github.com/ThisIsLibra/MalwareBazaarApi)
